<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner - Multi-Agent Supervisor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6; height: 100vh; display: flex; flex-direction: column;
            color: #1f2937;
        }

        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 24px; background: #fff; border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-icon {
            width: 36px; height: 36px; background: #4f46e5; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 18px; font-weight: 700;
        }
        .header h1 { font-size: 17px; font-weight: 600; }
        .header p { font-size: 12px; color: #9ca3af; margin-top: 1px; }
        .header-badge {
            font-size: 11px; background: #eef2ff; color: #4338ca; padding: 4px 10px;
            border-radius: 20px; font-weight: 500;
        }

        .messages { flex: 1; overflow-y: auto; padding: 24px 16px; }
        .messages-inner { max-width: 800px; margin: 0 auto; }

        .empty-state { text-align: center; padding: 60px 0; }
        .empty-state h2 { font-size: 22px; color: #374151; margin-bottom: 8px; font-weight: 600; }
        .empty-state p { color: #9ca3af; font-size: 14px; margin-bottom: 24px; }
        .suggestions { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; max-width: 700px; margin: 0 auto; }
        .suggestion {
            padding: 8px 14px; background: #fff; border: 1px solid #e5e7eb; border-radius: 20px;
            font-size: 12px; color: #4f46e5; cursor: pointer; transition: all 0.15s;
        }
        .suggestion:hover { background: #eef2ff; border-color: #c7d2fe; }

        .msg { display: flex; margin-bottom: 16px; }
        .msg.user { justify-content: flex-end; }
        .msg.assistant { justify-content: flex-start; }
        .bubble {
            max-width: 720px; padding: 12px 16px; border-radius: 16px;
            font-size: 14px; line-height: 1.6;
        }
        .msg.user .bubble { background: #4f46e5; color: #fff; border-bottom-right-radius: 4px; }
        .msg.assistant .bubble {
            background: #fff; border: 1px solid #e5e7eb; color: #1f2937;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04); border-bottom-left-radius: 4px;
        }
        .msg.assistant .bubble h1, .msg.assistant .bubble h2, .msg.assistant .bubble h3 { margin-top: 12px; margin-bottom: 6px; }
        .msg.assistant .bubble h1 { font-size: 18px; }
        .msg.assistant .bubble h2 { font-size: 16px; }
        .msg.assistant .bubble h3 { font-size: 14px; font-weight: 600; }
        .msg.assistant .bubble ul, .msg.assistant .bubble ol { padding-left: 20px; margin: 6px 0; }
        .msg.assistant .bubble li { margin-bottom: 3px; }
        .msg.assistant .bubble p { margin-bottom: 8px; }

        /* DAG Flow Diagram */
        .flow-diagram {
            background: #fff; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 16px; margin-bottom: 12px; max-width: 800px;
            overflow-x: auto;
        }
        .flow-title {
            font-size: 10px; color: #9ca3af; text-transform: uppercase;
            letter-spacing: 0.8px; margin-bottom: 12px; font-weight: 600;
        }
        .dag-container {
            display: flex; align-items: center; gap: 8px;
            justify-content: center; min-height: 48px;
        }
        .dag-node {
            padding: 7px 14px; border-radius: 8px; font-size: 11px; font-weight: 500;
            white-space: nowrap; transition: all 0.3s ease; position: relative;
        }
        .dag-node.supervisor-start { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .dag-node.supervisor-end { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .dag-node.weather { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .dag-node.packing { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .dag-node.activities { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .dag-node.budget { background: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }
        .dag-node.transport { background: #f3e8ff; color: #6b21a8; border: 1px solid #e9d5ff; }

        .dag-node.active {
            box-shadow: 0 0 0 2px rgba(79,70,229,0.5);
            animation: pulse-shadow 1.5s ease-in-out infinite;
        }
        .dag-node.completed::after {
            content: '\2713'; position: absolute; top: -6px; right: -6px;
            background: #16a34a; color: #fff; width: 16px; height: 16px;
            border-radius: 50%; font-size: 10px; display: flex;
            align-items: center; justify-content: center;
        }
        .dag-node.pending { opacity: 0.45; }
        .dag-node.error { border-color: #fca5a5; background: #fef2f2; }
        .dag-node.error::after {
            content: '\2717'; position: absolute; top: -6px; right: -6px;
            background: #dc2626; color: #fff; width: 16px; height: 16px;
            border-radius: 50%; font-size: 10px; display: flex;
            align-items: center; justify-content: center;
        }

        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 0 2px rgba(79,70,229,0.5); }
            50% { box-shadow: 0 0 0 4px rgba(79,70,229,0.25); }
        }

        .dag-arrow { color: #d1d5db; font-size: 14px; flex-shrink: 0; }

        /* Parallel group */
        .dag-parallel {
            display: flex; flex-direction: column; gap: 6px;
            padding: 8px 10px; border: 1.5px dashed #c7d2fe;
            border-radius: 10px; background: rgba(79,70,229,0.025);
            position: relative;
        }
        .dag-parallel-badge {
            position: absolute; top: -8px; left: 50%; transform: translateX(-50%);
            font-size: 9px; background: #eef2ff; color: #4f46e5;
            padding: 1px 6px; border-radius: 8px; white-space: nowrap;
            border: 1px solid #c7d2fe; font-weight: 500;
        }

        /* Status bar */
        .status-bar {
            display: flex; align-items: center; gap: 10px; padding: 10px 16px;
            margin-bottom: 12px; font-size: 13px; color: #6b7280;
        }
        .spinner {
            width: 16px; height: 16px; border: 2px solid #e5e7eb;
            border-top-color: #4f46e5; border-radius: 50%;
            animation: spin 0.8s linear infinite; flex-shrink: 0;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Agent result cards */
        .agent-card {
            border-radius: 12px; padding: 14px 16px; margin-bottom: 12px;
            font-size: 13px; line-height: 1.5; max-width: 720px;
        }
        .agent-card.weather { background: #eff6ff; border: 1px solid #bfdbfe; }
        .agent-card.packing { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .agent-card.activities { background: #fef3c7; border: 1px solid #fde68a; }
        .agent-card.budget { background: #fce7f3; border: 1px solid #fbcfe8; }
        .agent-card.transport { background: #f3e8ff; border: 1px solid #e9d5ff; }
        .agent-card .card-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
            font-weight: 600; font-size: 13px;
        }
        .agent-card.weather .card-header { color: #1e40af; }
        .agent-card.packing .card-header { color: #166534; }
        .agent-card.activities .card-header { color: #92400e; }
        .agent-card.budget .card-header { color: #9d174d; }
        .agent-card.transport .card-header { color: #6b21a8; }
        .agent-card .card-icon { font-size: 15px; }
        .agent-card .tools-used {
            font-size: 11px; color: #6b7280; margin-top: 8px;
            padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.06);
        }
        .agent-card .tools-used code {
            background: rgba(0,0,0,0.06); padding: 1px 5px; border-radius: 3px; font-size: 11px;
        }
        .agent-card .preview {
            color: #374151; white-space: pre-wrap; max-height: 100px;
            overflow-y: auto; font-family: inherit; font-size: 12px;
        }

        .input-area {
            padding: 16px; background: #fff; border-top: 1px solid #e5e7eb; flex-shrink: 0;
        }
        .input-row {
            max-width: 800px; margin: 0 auto; display: flex; gap: 10px; align-items: flex-end;
        }
        .input-row textarea {
            flex: 1; resize: none; border: 1px solid #d1d5db; border-radius: 12px;
            padding: 12px 16px; font-size: 14px; font-family: inherit;
            outline: none; min-height: 44px; max-height: 120px; line-height: 1.4;
        }
        .input-row textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79,70,229,0.15); }
        .send-btn {
            padding: 10px 18px; background: #4f46e5; color: #fff; border: none;
            border-radius: 12px; cursor: pointer; font-weight: 500; font-size: 14px;
            transition: background 0.15s; white-space: nowrap;
        }
        .send-btn:hover { background: #4338ca; }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-icon">T</div>
            <div>
                <h1>Trip Planner</h1>
                <p>Dynamic Multi-Agent Supervisor on Databricks Apps</p>
            </div>
        </div>
        <span class="header-badge">5 Agents &middot; 5 MCP Servers &middot; Dynamic Routing</span>
    </div>

    <div class="messages" id="messages">
        <div class="messages-inner" id="messages-inner">
            <div id="empty-state" class="empty-state">
                <h2>Plan your next trip</h2>
                <p>The supervisor dynamically decides which agents to use based on your question.</p>
                <div class="suggestions">
                    <div class="suggestion" onclick="fillAndSend('Plan a 5-day trip to Tokyo')">Plan a 5-day trip to Tokyo</div>
                    <div class="suggestion" onclick="fillAndSend('How much would a week in Paris cost?')">How much would Paris cost?</div>
                    <div class="suggestion" onclick="fillAndSend('What should I pack for London next week?')">What to pack for London?</div>
                    <div class="suggestion" onclick="fillAndSend('What are the best things to do in Rome?')">Things to do in Rome?</div>
                    <div class="suggestion" onclick="fillAndSend('How do I get to Bangkok and get around?')">Getting to/around Bangkok?</div>
                    <div class="suggestion" onclick="fillAndSend('Plan a complete budget trip to Reykjavik')">Budget trip to Reykjavik</div>
                </div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-row">
            <textarea id="input" rows="1" placeholder="Ask about any trip - the supervisor will pick the right agents..."
                      onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
            <button class="send-btn" id="send-btn" onclick="send()">Send</button>
        </div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages-inner');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('send-btn');
        const emptyState = document.getElementById('empty-state');
        let loading = false;

        const AGENT_META = {
            weather:    { icon: '\u2601', label: 'Weather Agent' },
            packing:    { icon: '\uD83C\uDF92', label: 'Packing Agent' },
            activities: { icon: '\uD83C\uDFAF', label: 'Activities Agent' },
            budget:     { icon: '\uD83D\uDCB0', label: 'Budget Agent' },
            transport:  { icon: '\u2708', label: 'Transport Agent' },
        };

        // DAG state
        let flowState = {
            rounds: [],          // [{agents: ['weather'], parallel: false}, {agents: ['packing','activities'], parallel: true}]
            planned: [],         // All planned agent keys
            active: new Set(),
            completed: new Set(),
            errors: new Set(),
            synthesizing: false,
            done: false,
        };

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        function autoGrow(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }
        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
        }
        function scrollToBottom() {
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
        function removeElement(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function addUserMessage(text) {
            if (emptyState) emptyState.style.display = 'none';
            const div = document.createElement('div');
            div.className = 'msg user';
            div.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function addAssistantMessage(html) {
            const div = document.createElement('div');
            div.className = 'msg assistant';
            div.innerHTML = `<div class="bubble">${html}</div>`;
            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function getAgentState(agentKey) {
            if (flowState.errors.has(agentKey)) return 'error';
            if (flowState.active.has(agentKey)) return 'active';
            if (flowState.completed.has(agentKey)) return 'completed';
            return 'pending';
        }

        function renderFlowDiagram() {
            removeElement('flow-diagram');
            if (flowState.rounds.length === 0 && flowState.planned.length === 0) return;

            const div = document.createElement('div');
            div.id = 'flow-diagram';
            div.className = 'flow-diagram';

            let html = '<div class="dag-container">';

            // Supervisor start node
            const startDone = flowState.rounds.length > 0;
            html += `<span class="dag-node supervisor-start ${startDone ? 'completed' : 'active'}">Supervisor</span>`;

            // Render each execution round
            flowState.rounds.forEach((round) => {
                html += '<span class="dag-arrow">\u2192</span>';

                if (round.parallel && round.agents.length > 1) {
                    // Parallel group
                    html += '<div class="dag-parallel">';
                    html += '<span class="dag-parallel-badge">parallel</span>';
                    round.agents.forEach(agentKey => {
                        const meta = AGENT_META[agentKey] || { icon: '?', label: agentKey };
                        const state = getAgentState(agentKey);
                        html += `<span class="dag-node ${agentKey} ${state}">${meta.icon} ${meta.label}</span>`;
                    });
                    html += '</div>';
                } else {
                    // Single agent
                    const agentKey = round.agents[0];
                    const meta = AGENT_META[agentKey] || { icon: '?', label: agentKey };
                    const state = getAgentState(agentKey);
                    html += `<span class="dag-node ${agentKey} ${state}">${meta.icon} ${meta.label}</span>`;
                }
            });

            // Supervisor synthesis node (show once at least one round exists)
            if (flowState.rounds.length > 0) {
                html += '<span class="dag-arrow">\u2192</span>';
                let synthState = 'pending';
                if (flowState.done) synthState = 'completed';
                else if (flowState.synthesizing) synthState = 'active';
                html += `<span class="dag-node supervisor-end ${synthState}">\u2728 Synthesis</span>`;
            }

            html += '</div>';
            div.innerHTML = `<div class="flow-title">Agent Orchestration Flow</div>${html}`;
            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function showStatus(message) {
            removeElement('current-status');
            const div = document.createElement('div');
            div.id = 'current-status';
            div.className = 'status-bar';
            div.innerHTML = `<div class="spinner"></div><span>${escapeHtml(message)}</span>`;
            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function showAgentResult(agent, result, toolsCalled, isError) {
            removeElement('current-status');
            const meta = AGENT_META[agent] || { icon: '?', label: agent };
            const preview = result.length > 250 ? result.substring(0, 250) + '...' : result;
            let toolsHtml = '';
            if (toolsCalled && toolsCalled.length > 0) {
                const toolNames = toolsCalled.map(t => `<code>${t.tool}</code>`).join(', ');
                toolsHtml = `<div class="tools-used">MCP tools used: ${toolNames}</div>`;
            }
            const div = document.createElement('div');
            div.className = `agent-card ${agent}`;
            div.innerHTML = `
                <div class="card-header"><span class="card-icon">${meta.icon}</span> ${meta.label} ${isError ? 'failed' : 'completed'}</div>
                <div class="preview">${escapeHtml(preview)}</div>
                ${toolsHtml}`;
            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function fillAndSend(text) {
            inputEl.value = text;
            send();
        }

        async function send() {
            const text = inputEl.value.trim();
            if (!text || loading) return;

            loading = true;
            sendBtn.disabled = true;
            inputEl.value = '';
            inputEl.style.height = 'auto';
            addUserMessage(text);

            // Reset flow state
            flowState = {
                rounds: [], planned: [],
                active: new Set(), completed: new Set(), errors: new Set(),
                synthesizing: false, done: false,
            };

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text }),
                });

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.startsWith('data:')) continue;
                        const raw = line.slice(5).trim();
                        if (!raw) continue;
                        try {
                            const event = JSON.parse(raw);
                            switch (event.type) {
                                case 'status':
                                    showStatus(event.message);
                                    break;

                                case 'plan':
                                    flowState.planned = event.agents || [];
                                    renderFlowDiagram();
                                    showStatus(`Plan: ${flowState.planned.map(a => AGENT_META[a]?.label || a).join(', ')}`);
                                    break;

                                case 'plan_update':
                                    flowState.planned = event.agents || flowState.planned;
                                    renderFlowDiagram();
                                    showStatus(event.reason || 'Plan updated');
                                    break;

                                case 'round_start':
                                    // A new execution round - add to rounds
                                    flowState.rounds.push({
                                        agents: event.agents,
                                        parallel: event.parallel,
                                    });
                                    renderFlowDiagram();
                                    if (event.parallel) {
                                        const labels = event.agents.map(a => AGENT_META[a]?.label || a).join(' + ');
                                        showStatus(`Running in parallel: ${labels}`);
                                    }
                                    break;

                                case 'agent_start':
                                    flowState.active.add(event.agent);
                                    renderFlowDiagram();
                                    showStatus(`${AGENT_META[event.agent]?.icon || ''} ${AGENT_META[event.agent]?.label || event.agent} working...`);
                                    break;

                                case 'agent_result':
                                    flowState.active.delete(event.agent);
                                    if (event.is_error) {
                                        flowState.errors.add(event.agent);
                                    } else {
                                        flowState.completed.add(event.agent);
                                    }
                                    renderFlowDiagram();
                                    showAgentResult(event.agent, event.result, event.tools_called, event.is_error);
                                    break;

                                case 'synthesis_start':
                                    flowState.synthesizing = true;
                                    renderFlowDiagram();
                                    showStatus('Synthesizing final response...');
                                    break;

                                case 'response':
                                    removeElement('current-status');
                                    flowState.synthesizing = false;
                                    flowState.done = true;
                                    renderFlowDiagram();
                                    addAssistantMessage(marked.parse(event.text));
                                    break;

                                case 'error':
                                    removeElement('current-status');
                                    removeElement('flow-diagram');
                                    addAssistantMessage(`<strong style="color:#dc2626">Error:</strong> ${escapeHtml(event.error)}`);
                                    break;

                                case 'done':
                                    break;
                            }
                        } catch (e) { /* skip parse errors */ }
                    }
                }
            } catch (err) {
                removeElement('current-status');
                removeElement('flow-diagram');
                addAssistantMessage(`<strong style="color:#dc2626">Connection error:</strong> ${escapeHtml(err.message)}`);
            } finally {
                loading = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        }
    </script>
</body>
</html>
